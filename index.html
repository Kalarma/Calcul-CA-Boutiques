<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LGDJ — Extracteur CA (Offline)</title>
  <style>
    :root{
      --ver: "v0.7.1";

      --bg0:#0b1020;
      --bg1:#0c1426;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(0,0,0,.20);
      --text:#eef2ff;
      --muted:#aab3c7;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 55px rgba(0,0,0,.45);

      --pri:#4f46e5;
      --pri2:#22c55e;
      --warn:#f59e0b;
      --bad:#fb7185;

      /* base hue for pies */
      --pieBase:#60a5fa;

      --r:18px;
      --btn: rgba(255,255,255,.08);
      --btnH: rgba(255,255,255,.12);
      --chip: rgba(255,255,255,.06);
      --input: rgba(0,0,0,.18);

      /* hover highlight */
      --hoverTxt: rgba(238,242,255,.92);
      --hoverStroke: rgba(255,255,255,.22);
      --hoverGlow: 0 0 0 2px rgba(255,255,255,.10) inset;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(79,70,229,.20), transparent 60%),
        radial-gradient(900px 520px at 80% 14%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    .app{height:100vh; display:flex; flex-direction:column;}

    .topbar{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .brand{display:flex;align-items:center;gap:10px;font-weight:950;letter-spacing:.2px;min-width:0}
    .logo{
      width:36px;height:36px;border-radius:14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(79,70,229,.18), rgba(34,197,94,.10));
      display:grid;place-items:center;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .brandTitle{display:flex;flex-direction:column;line-height:1.05;min-width:0}
    .brandTitle .ttl{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .verRow{display:flex;align-items:center;gap:10px;margin-top:2px;min-width:0}
    .verBtn{
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      background:transparent;
      border:none;
      padding:0;
      text-align:left;
      cursor:pointer;
      white-space:nowrap;
    }
    .verBtn:hover{color:var(--text)}
    .dateInfo{
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .chipBtn{
      cursor:pointer;
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background: var(--chip);
      padding:6px 10px;border-radius:999px;
      white-space:nowrap;
      font-weight:900;
    }
    .chipBtn:hover{background: rgba(255,255,255,.10); color:var(--text)}

    button{
      cursor:pointer;
      border:1px solid var(--line);
      background: var(--btn);
      color:var(--text);
      padding:8px 10px;
      border-radius: 12px;
      font-weight:900;
      font-size:12px;
      transition: background .15s ease, transform .04s ease;
      user-select:none;
    }
    button:hover{background:var(--btnH)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .btnTutor{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .btnTutor:hover{background: rgba(34,197,94,.18)}
    .btnGear{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10)}
    .btnGear:hover{background: rgba(245,158,11,.16)}
    .btnPrimary{border-color: rgba(79,70,229,.35); background: rgba(79,70,229,.14)}
    .btnPrimary:hover{background: rgba(79,70,229,.20)}

    .main{
      flex:1;
      padding:0 14px 14px;
      display:grid;
      grid-template-columns: .62fr 1.38fr; /* input slimmer */
      gap:12px;
      min-height:0;
    }
    @media(max-width:980px){
      .main{grid-template-columns:1fr;}
    }

    .panel{
      border:1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius: var(--r);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(10px);
    }

    .panel .hd{
      padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background: var(--panel2);
    }

    .hdTitle{
      font-weight:950;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .rightHdRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:100%;
      min-width:0;
    }
    .rightDate{
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .bd{padding:12px; min-height:0;}

    textarea, input{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--input);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:13px;
      line-height:1.35;
    }

    textarea{resize:none; min-height:0; overflow:auto; height: 33vh;} /* ~1/3 écran */

    .inputGrid{
      display:grid;
      grid-template-rows: auto 1fr;
      gap:10px;
      height:100%;
      min-height:0;
    }

    /* Right side scrolls */
    .rightScroll{
      height:100%;
      overflow:auto;
      padding:12px;
      display:grid;
      gap:12px;
    }

    .alert{
      border:1px solid rgba(245,158,11,.40);
      background: rgba(245,158,11,.10);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:850;
      font-size:12px;
      display:none;
    }

    .combo{
      border-radius: var(--r);
      border:1px solid var(--line);
      background: var(--panel);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      backdrop-filter: blur(10px);
    }
    .comboHd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: var(--panel2);
    }
    .comboBd{
      padding:12px 14px;
      display:grid;
      grid-template-columns: 200px 1fr;
      gap:14px;
      align-items:start;
      min-height:0;
    }
    @media(max-width:980px){.comboBd{grid-template-columns:1fr}}

    .crumb{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:980;
      min-width:0;
    }
    .crumb span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .hint{color:var(--muted);font-weight:850;font-size:12px;white-space:nowrap}

    .legend{
      display:grid;
      gap:8px;
      min-height:0;
      max-height: 52vh;
      overflow:auto;
      padding-right:6px;
    }
    .legRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 0; border-bottom:1px dashed rgba(125,125,155,.22);
      cursor:pointer;
      border-radius:10px;
    }
    .legRow:last-child{border-bottom:none}
    .legRow:hover{box-shadow: var(--hoverGlow);}
    .legRow:hover .legName{color:var(--text)}

    .legRow.isHover .legName{color:var(--hoverTxt)}
    .legRow.isHover{box-shadow: var(--hoverGlow);}

    .legL{display:flex;align-items:center;gap:10px; min-width:0;}
    .sw{width:10px;height:10px;border-radius:4px; flex:0 0 auto;}
    .legName{color:var(--muted);font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .legVal{font-weight:950; white-space:nowrap;}

    .totals{display:grid;gap:10px;margin-top:10px;}
    .totalBox{
      border-radius: 14px;
      padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid var(--line);
      background: var(--panel2);
    }
    .totalLabel{font-weight:980;letter-spacing:.15px}
    .totalValue{font-weight:980;font-size:18px}

    .empty{padding:22px;color:var(--muted);text-align:center;font-weight:900}

    /* Modal base */
    .modalBg{
      position:fixed;inset:0;background: rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .modal{
      width:min(920px, 100%);
      max-height: min(86vh, 900px);
      overflow:auto;
      border-radius: 18px;
      border:1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .modal .mhd{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background: var(--panel2);
    }
    .modal .mbd{padding:14px 16px;}

    /* Tutoriel — encadré */
    .tutShell{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      overflow:hidden;
    }
    .tutTop{
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(79,70,229,.14), rgba(0,0,0,.10));
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .tutTitle{
      font-weight:980;
      letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .tutStep{
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .tutBody{padding:12px 14px}
    .tutBody h3{margin:0 0 8px 0; font-size:15px}
    .tutBody p{margin:0; color:var(--text); line-height:1.55}
    .pager{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:12px;}
    .muted{color:var(--muted)}

    /* Settings */
    .label{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.2px;margin:10px 0 8px}
    .seg{display:flex;gap:8px;flex-wrap:wrap;}
    .seg button{border-radius:999px;padding:8px 12px;font-size:12px;font-weight:950;}
    .seg button.active{border-color: rgba(79,70,229,.45);background: rgba(79,70,229,.18);}

    /* Pie slices */
    .slice{cursor:pointer; transition: opacity .15s ease, filter .15s ease;}
    .slice:hover{opacity:.90}
    .slice.isHover{
      filter: drop-shadow(0 0 8px rgba(255,255,255,.12));
      opacity: .96;
      stroke: var(--hoverStroke);
      stroke-width: 1.25;
    }

    .foot{
      padding:0 14px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      color:var(--muted);font-size:11px;font-weight:800;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .contact{color:var(--muted);font-size:11px;font-weight:900}
  </style>
</head>

<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 19V5" stroke="currentColor" stroke-opacity=".9" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 19H20" stroke="currentColor" stroke-opacity=".9" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 16V11" stroke="currentColor" stroke-opacity=".85" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 16V8" stroke="currentColor" stroke-opacity=".85" stroke-width="2" stroke-linecap="round"/>
            <path d="M16 16V13" stroke="currentColor" stroke-opacity=".85" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="brandTitle">
          <div class="ttl">Extracteur CA</div>
          <div class="verRow">
            <button class="verBtn" id="btnVer">v0.7.1</button>
            <div class="dateInfo" id="dateInfo">—</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="chipBtn" id="btnStats">Lues: <span class="mono" id="metaLines">0</span> • Utilisées: <span class="mono" id="metaUsed">0</span> • Erreurs: <span class="mono" id="metaErr">0</span></button>
        <button class="btnTutor" id="btnTut">Tutoriel</button>
        <button class="btnGear" id="btnSettings">Paramètres</button>
      </div>
    </div>

    <div class="main">
      <!-- INPUT -->
      <section class="panel">
        <div class="hd">
          <div class="hdTitle">Copier-coller PrestaShop</div>
          <div class="actions">
            <button class="btnPrimary" id="btnPaste">Coller</button>
            <button id="btnClear">Vider</button>
          </div>
        </div>

        <div class="bd inputGrid">
          <textarea id="raw" placeholder="Colle ici le tableau PrestaShop (Ctrl+V).\n\nSur PrestaShop : Ctrl+A → Ctrl+C → ici Ctrl+V."></textarea>
          <div class="muted" style="font-size:12px;line-height:1.4">
            Analyse automatique dès qu’il y a du texte.
          </div>
        </div>
      </section>

      <!-- OUTPUT -->
      <section class="panel">
        <div class="hd">
          <div class="rightHdRow">
            <div class="hdTitle" id="rightTitle">Résultats</div>
            <div class="rightDate" id="rightDate">—</div>
          </div>
          <div class="actions">
            <button id="btnBack" style="display:none">Retour</button>
          </div>
        </div>

        <div class="bd" style="padding:0">
          <div class="rightScroll" id="rightBody">
            <div class="alert" id="warnTwo">⚠️ Deux boutiques détectées. On affiche uniquement les totaux GLOBAL par catégories (pas de détails boutique).</div>
          </div>
        </div>
      </section>
    </div>

    <div class="foot">
      <div class="mono">LGDJ — <span id="ver2">v0.7.1</span></div>
      <div class="contact">Si problème ou suggestion d’amélioration : contacter Zao</div>
      <div>Offline • Drilldown • HT</div>
    </div>
  </div>

  <!-- Tutoriel modal -->
  <div class="modalBg" id="tutBg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" aria-label="Tutoriel" style="width:min(860px, 100%)">
      <div class="mhd">
        <div style="font-weight:980">Tutoriel</div>
        <button id="btnCloseTut">Fermer</button>
      </div>
      <div class="mbd">
        <div class="tutShell">
          <div class="tutTop">
            <div class="tutTitle" id="tutHead">—</div>
            <div class="tutStep"><span id="tutIdx">1</span>/<span id="tutTotal">1</span></div>
          </div>
          <div class="tutBody" id="tutContent"></div>
        </div>
        <div class="pager">
          <button id="tutPrev">Précédent</button>
          <div class="muted" style="font-size:12px">Ctrl+A → Ctrl+C sur le tableau, puis Ctrl+V ici.</div>
          <button id="tutNext" class="btnPrimary">Suivant</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div class="modalBg" id="setBg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" aria-label="Paramètres" style="width:min(820px, 100%)">
      <div class="mhd">
        <div style="font-weight:980">Paramètres</div>
        <button id="btnCloseSet">Fermer</button>
      </div>
      <div class="mbd">
        <div class="label">Quantités</div>
        <div class="seg" role="group" aria-label="Quantités">
          <button id="qtyOff">Cachées</button>
          <button id="qtyOn">Visibles</button>
        </div>

        <div class="label">Puzzles & Casse-têtes réunis ?</div>
        <div class="seg" role="group" aria-label="Puzzles et casse-têtes">
          <button id="mergePCNo">Non</button>
          <button id="mergePCYes">Oui</button>
        </div>

        <div class="label">Événements indépendants ?</div>
        <div class="muted" style="font-size:12px;margin-bottom:8px;line-height:1.4">
          Oui = tout regrouper dans une catégorie parent “Événement”. Non = laisser les événements dans leur catégorie (Jeux/TCG/etc.).
        </div>
        <div class="seg" role="group" aria-label="Événements">
          <button id="evtNo">Non</button>
          <button id="evtYes">Oui</button>
        </div>

        <div class="label">Jeux de rôles indépendants ?</div>
        <div class="muted" style="font-size:12px;margin-bottom:8px;line-height:1.4">
          Oui = catégorie parent “Jeux de rôles”. Non = intégrer à “Jeux de société”.
        </div>
        <div class="seg" role="group" aria-label="JDR">
          <button id="jdrNo">Non</button>
          <button id="jdrYes">Oui</button>
        </div>

        <div class="label">Accessoires TCG rangés dans leur TCG ?</div>
        <div class="muted" style="font-size:12px;margin-bottom:8px;line-height:1.4">
          Oui = “Accessoires Pokémon” va dans “Pokémon”. Non = va dans “Accessoires”.
        </div>
        <div class="seg" role="group" aria-label="Accessoires TCG">
          <button id="tcgAccNo">Non</button>
          <button id="tcgAccYes">Oui</button>
        </div>

        <div class="muted" style="margin-top:12px;font-size:12px;line-height:1.45">
          Note : si la colonne Quantité n’est pas présente, l’app affiche “—”.
        </div>
      </div>
    </div>
  </div>

  <!-- Version / Changelog modal -->
  <div class="modalBg" id="verBg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" aria-label="Changelog">
      <div class="mhd">
        <div style="font-weight:980">Changelog</div>
        <button id="btnCloseVer">Fermer</button>
      </div>
      <div class="mbd" id="verContent"></div>
    </div>
  </div>

  <!-- Stats debug modal -->
  <div class="modalBg" id="statsBg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" aria-label="Détails des lignes">
      <div class="mhd">
        <div style="font-weight:980">Détails des lignes</div>
        <button id="btnCloseStats">Fermer</button>
      </div>
      <div class="mbd">
        <div class="seg" style="margin-bottom:10px">
          <button class="tabBtn active" data-tab="used">Utilisées</button>
          <button class="tabBtn" data-tab="err">Erreurs</button>
          <button class="tabBtn" data-tab="ignored">Ignorées</button>
        </div>

        <div class="muted" id="statsHint" style="margin-bottom:10px;font-size:12px"></div>
        <div class="mono" id="statsBox" style="
          border:1px solid var(--line);
          background: rgba(0,0,0,.22);
          border-radius:14px;
          padding:10px 12px;
          white-space:pre-wrap;
          font-size:12px;
          line-height:1.45;
          max-height: 56vh;
          overflow:auto;
        ">—</div>

        <div class="pager" style="justify-content:flex-end">
          <button id="btnCopyStats" class="btnPrimary">Copier</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const VERSION = "v0.7.1";

  // Licences (tu me diras quand ajouter/retirer)
  const TCG_LICENSES = [
    "Pokémon", "Lorcana", "One Piece", "Magic", "Altered", "Flesh and Blood",
    "Star Wars Unlimited", "Riftbound", "Yu-Gi-Oh", "Naruto"
  ];

  const ACCESSORY_KEYWORDS = [
    "accessoire","accessoires","accessoires cartes","protège-carte","protege-carte","sleeve","sleeves",
    "deck box","classeur","portfolio","binder",
    "des","dés","piste de des","piste de dés","pistes de des","pistes de dés",
    "protections acryliques","grenier ludique","booknooks","tapis","playmat"
  ];

  const PUZZLE_KEYWORDS = [
    "puzzle","puzzles","logique et puzzles",
    "cavallini",
    "jour ferie","jours feries","jour férié","jours fériés",
    "puzzle 100p","puzzle 500p","puzzle 1000p","puzzle 3d"
  ];

  const CASSE_KEYWORDS = [
    "casse-tete","casse-têtes","casse tete","casse tetes",
    "smart games","smartgame","perplexus"
  ];

  const JDR_KEYWORDS = [
    "donjons et chatons",
    "jeux de roles","jeux de rôle","jeux de rôles","jeu de roles","jeu de rôle",
    "jeux de roles solo","jeux de rôles solo","jdr",
    "manuels"
  ];

  const OTHER_KEYWORDS = [
    "categorie supprimee","catégorie supprimée","categorie supprimée",
    "accueil","livraison","acompte","tests","test",
    "totaux (","totaux("
  ];

  const EVENT_KEYWORDS = ["evenement","évènement","evenements","évènements"];

  const BOUTIQUES = [
    { key: "GAMBETTA", label: "LGDJ Gambetta", needles: ["lgdj gambetta","gambetta"] },
    { key: "PIGALLE", label: "LGDJ Pigalle", needles: ["lgdj pigalle","pigalle"] }
  ];

  // Lignes à ignorer (pas des "erreurs")
  const IGNORE_LINE_PATTERNS = [
    "-commande en attente de retrait - gambetta",
    "-commande en attente de retrait - pigalle"
  ];

  const el = (id) => document.getElementById(id);
  const els = {
    metaLines: el('metaLines'), metaUsed: el('metaUsed'), metaErr: el('metaErr'),
    dateInfo: el('dateInfo'),
    rightDate: el('rightDate'),

    raw: el('raw'),
    btnPaste: el('btnPaste'),
    btnClear: el('btnClear'),
    btnBack: el('btnBack'),

    rightTitle: el('rightTitle'),
    rightBody: el('rightBody'),
    warnTwo: el('warnTwo'),

    // tutoriel
    btnTut: el('btnTut'),
    tutBg: el('tutBg'),
    btnCloseTut: el('btnCloseTut'),
    tutHead: el('tutHead'),
    tutContent: el('tutContent'),
    tutPrev: el('tutPrev'),
    tutNext: el('tutNext'),
    tutIdx: el('tutIdx'),
    tutTotal: el('tutTotal'),

    // settings
    btnSettings: el('btnSettings'),
    setBg: el('setBg'),
    btnCloseSet: el('btnCloseSet'),
    qtyOff: el('qtyOff'),
    qtyOn: el('qtyOn'),
    mergePCNo: el('mergePCNo'),
    mergePCYes: el('mergePCYes'),
    evtNo: el('evtNo'),
    evtYes: el('evtYes'),
    jdrNo: el('jdrNo'),
    jdrYes: el('jdrYes'),
    tcgAccNo: el('tcgAccNo'),
    tcgAccYes: el('tcgAccYes'),

    // version
    btnVer: el('btnVer'),
    ver2: el('ver2'),
    verBg: el('verBg'),
    btnCloseVer: el('btnCloseVer'),
    verContent: el('verContent'),

    // stats
    btnStats: el('btnStats'),
    statsBg: el('statsBg'),
    btnCloseStats: el('btnCloseStats'),
    statsHint: el('statsHint'),
    statsBox: el('statsBox'),
    btnCopyStats: el('btnCopyStats'),
  };

  const settings = {
    showQty: (localStorage.getItem('lgdj_qty') || 'OFF'),              // OFF/ON
    mergePuzzleCasse: (localStorage.getItem('lgdj_merge_pc') || 'NO'), // NO/YES
    eventsStandalone: (localStorage.getItem('lgdj_evt') || 'NO'),      // NO/YES
    jdrStandalone: (localStorage.getItem('lgdj_jdr') || 'NO'),         // NO/YES
    tcgAccessoriesInTcg: (localStorage.getItem('lgdj_tcgacc') || 'YES')// YES/NO (default YES)
  };

  let parsed = null;
  let view = { level: 'dashboard', category: null, tcgLicense: null, globalOnly: false };

  // Debug lists
  let debug = { used: [], err: [], ignored: [] };

  // Hover mapping (pie <-> legend)
  let hover = { key:null };

  function normalize(s){
    return (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();
  }

  function parseMoneyToNumber(token){
    let t = token.replace(/[^0-9,.-]/g,"").replace(/\s+/g,"").trim();
    if(!t) return null;
    const hasComma = t.includes(",");
    const hasDot = t.includes(".");
    let cleaned = t;
    if(hasComma && hasDot){
      const lc = cleaned.lastIndexOf(",");
      const ld = cleaned.lastIndexOf(".");
      if(ld > lc) cleaned = cleaned.replace(/,/g,"");
      else cleaned = cleaned.replace(/\./g,"").replace(/,/g,".");
    } else if(hasComma && !hasDot){
      cleaned = cleaned.replace(/,/g,".");
    }
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : null;
  }

  function extractHTFromLine(line){
    const moneyTokens = [...line.matchAll(/(-?\d[\d\s.,]*)(\$|€)/g)].map(m => m[0]);
    if(moneyTokens.length === 0) return null;
    const nums = moneyTokens.map(parseMoneyToNumber).filter(v => typeof v === 'number');
    if(nums.length >= 3) return nums[2]; // Total produits HT (format PrestaShop export cat)
    return nums.length ? nums[nums.length - 1] : null;
  }

  // Qty: accepte aussi "0"
  function extractQtyFromLine(line){
    const parts = line.split("\t").map(p=>p.trim());
    if(parts.length >= 5){
      const v = parts[3];
      if(v === "" || v == null) return null;
      const q = Number(String(v).replace(',','.'));
      return Number.isFinite(q) ? q : null;
    }
    return null;
  }

  function extractCategoryName(line){
    const parts = line.split("\t").map(p=>p.trim()).filter(Boolean);
    if(parts.length >= 4) return parts[2];
    const m = line.match(/LGDJ\s+(?:Gambetta|Pigalle)\s+(?:\d+\s+)?(.+?)\s+\d+\s+0\$/i);
    if(m && m[1]) return m[1].trim();
    return line.replace(/^LGDJ\s+(Gambetta|Pigalle)\s*/i,"").slice(0,80).trim();
  }

  function detectBoutique(lineNorm){
    for(const b of BOUTIQUES){
      if(b.needles.some(n => lineNorm.includes(n))) return b.key;
    }
    return null;
  }

  function pickLicense(catNorm){
    for(const lic of TCG_LICENSES){
      const n = normalize(lic);
      if(n && catNorm.includes(n)) return n;
    }
    return null;
  }

  function prettyLicense(licNorm){
    const target = normalize(licNorm);
    for(const s of TCG_LICENSES){
      if(normalize(s) === target) return s;
    }
    return licNorm;
  }

  function hasAny(catNorm, arr){
    return arr.some(k => catNorm.includes(normalize(k)));
  }

  function isAccessory(catNorm){
    return hasAny(catNorm, ACCESSORY_KEYWORDS);
  }

  function isPuzzle(catNorm){
    return hasAny(catNorm, PUZZLE_KEYWORDS);
  }

  function isCasse(catNorm){
    return hasAny(catNorm, CASSE_KEYWORDS);
  }

  function isJdr(catNorm){
    return hasAny(catNorm, JDR_KEYWORDS);
  }

  function isOther(catNorm){
    return hasAny(catNorm, OTHER_KEYWORDS) || catNorm.trim()==="";
  }

  function isEvent(catNorm){
    return hasAny(catNorm, EVENT_KEYWORDS);
  }

  function isKids(catNorm){
    // Jeux X ans, Jeux enfants, + Défis Nature
    if(catNorm.includes("defis nature") || catNorm.includes("défis nature")) return true;
    if(catNorm.includes("jeux enfants")) return true;
    // jeux 2 ans / jeux 3 ans etc
    return /jeux\s*\d+\s*ans/.test(catNorm);
  }

  function escapeHtml(s){
    return (s||'').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function formatEUR(n){
    const v = Number.isFinite(n) ? n : 0;
    return v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function qtyText(q){
    return Number.isFinite(q) ? String(q) : "—";
  }

  // ----- date range -----
  function pad2(x){ return String(x).padStart(2,'0'); }
  function toFR(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
  function extractDateRange(raw){
    const m = raw.match(/Date de la commande\s*:\s*du\s*(\d{2}\/\d{2}\/\d{4})\s*au\s*(\d{2}\/\d{2}\/\d{4})/i);
    if(!m) return null;
    return { from: m[1], to: m[2] };
  }
  function dateLabel(range){
    if(!range) return "—";
    const today = new Date();
    const yesterday = new Date(Date.now() - 86400000);
    const t = toFR(today);
    const y = toFR(yesterday);

    const one = range.from === range.to;
    const base = one ? range.from : `${range.from} → ${range.to}`;
    const tag =
      one && range.from === t ? " (aujourd’hui)" :
      one && range.from === y ? " (hier)" :
      "";
    return base + tag;
  }

  // ----- Color utilities -----
  function hexToRgb(hex){
    const h = hex.replace('#','').trim();
    const full = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
    const n = parseInt(full, 16);
    return { r: (n>>16)&255, g: (n>>8)&255, b: n&255 };
  }
  function rgbToHex(r,g,b){
    const to = (x)=> x.toString(16).padStart(2,'0');
    return `#${to(r)}${to(g)}${to(b)}`;
  }
  function mix(a,b,t){ return Math.round(a + (b-a)*t); }
  function shadeHex(baseHex, t){
    const base = hexToRgb(baseHex);
    const dark = { r: 20, g: 30, b: 55 };
    const light = { r: 235, g: 242, b: 255 };
    if(t < 0.5){
      const tt = t/0.5;
      return rgbToHex(mix(dark.r, base.r, tt), mix(dark.g, base.g, tt), mix(dark.b, base.b, tt));
    } else {
      const tt = (t-0.5)/0.5;
      return rgbToHex(mix(base.r, light.r, tt), mix(base.g, light.g, tt), mix(base.b, light.b, tt));
    }
  }
  function getVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  // ===== pie svg =====
  function polarToCartesian(cx, cy, r, angle){
    const rad = (angle - 90) * Math.PI / 180.0;
    return { x: cx + (r * Math.cos(rad)), y: cy + (r * Math.sin(rad)) };
  }
  function arcPath(cx, cy, r, startAngle, endAngle){
    const start = polarToCartesian(cx, cy, r, endAngle);
    const end = polarToCartesian(cx, cy, r, startAngle);
    const largeArc = endAngle - startAngle <= 180 ? 0 : 1;
    return ['M', cx, cy,'L', start.x, start.y,'A', r, r, 0, largeArc, 0, end.x, end.y,'Z'].join(' ');
  }

  function setHover(key){
    hover.key = key;
    document.querySelectorAll('[data-slice-key]').forEach(p => {
      p.classList.toggle('isHover', p.getAttribute('data-slice-key') === key);
    });
    document.querySelectorAll('[data-row-key]').forEach(r => {
      r.classList.toggle('isHover', r.getAttribute('data-row-key') === key);
    });
  }
  function clearHover(){
    hover.key = null;
    document.querySelectorAll('.isHover').forEach(n => n.classList.remove('isHover'));
  }

  function renderComboPieAndTotals(data, title, totals, onPick){
    const total = data.reduce((a,b)=>a + (b.value||0), 0);

    const wrap = document.createElement('div');
    wrap.className = 'combo dyn';

    const hd = document.createElement('div');
    hd.className = 'comboHd';
    hd.innerHTML = `
      <div class="crumb"><span>${escapeHtml(title)}</span></div>
      <div class="hint">Survol = surlignage • Clic = ouvrir</div>
    `;
    wrap.appendChild(hd);

    const bd = document.createElement('div');
    bd.className = 'comboBd';

    const size = 200;
    const cx = size/2;
    const cy = size/2;
    const r = 88;

    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('width', String(size));
    svg.setAttribute('height', String(size));
    svg.setAttribute('viewBox', `0 0 ${size} ${size}`);

    const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
    bg.setAttribute('cx', cx);
    bg.setAttribute('cy', cy);
    bg.setAttribute('r', r);
    bg.setAttribute('fill', getVar('--panel2'));
    bg.setAttribute('stroke', getVar('--line'));
    bg.setAttribute('stroke-width', '1');
    svg.appendChild(bg);

    const base = getVar('--pieBase') || '#60a5fa';
    const items = data.filter(d => d.value > 0);

    let angle = 0;
    items.forEach((d, i) => {
      const slice = total > 0 ? (d.value / total) * 360 : 0;
      const start = angle;
      const end = angle + slice;
      angle = end;

      const t = items.length <= 1 ? 0.6 : (0.25 + (i/(items.length-1))*0.6);
      const color = shadeHex(base, t);
      d._color = color;

      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', arcPath(cx, cy, r, start, end));
      path.setAttribute('fill', color);
      path.setAttribute('stroke', 'rgba(0,0,0,.12)');
      path.setAttribute('stroke-width', '1');
      path.classList.add('slice');
      path.setAttribute('data-slice-key', d.key);

      path.addEventListener('mouseenter', () => setHover(d.key));
      path.addEventListener('mouseleave', () => clearHover());

      if(onPick) path.addEventListener('click', () => onPick(d));
      svg.appendChild(path);
    });

    const hole = document.createElementNS('http://www.w3.org/2000/svg','circle');
    hole.setAttribute('cx', cx);
    hole.setAttribute('cy', cy);
    hole.setAttribute('r', 50);
    hole.setAttribute('fill', getVar('--bg0'));
    hole.setAttribute('stroke', getVar('--line'));
    hole.setAttribute('stroke-width', '1');
    svg.appendChild(hole);

    const t1 = document.createElementNS('http://www.w3.org/2000/svg','text');
    t1.setAttribute('x', cx);
    t1.setAttribute('y', cy - 4);
    t1.setAttribute('text-anchor','middle');
    t1.setAttribute('fill', getVar('--text'));
    t1.setAttribute('font-size','13');
    t1.setAttribute('font-weight','900');
    t1.textContent = formatEUR(total);

    const t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
    t2.setAttribute('x', cx);
    t2.setAttribute('y', cy + 16);
    t2.setAttribute('text-anchor','middle');
    t2.setAttribute('fill', getVar('--muted'));
    t2.setAttribute('font-size','10');
    t2.setAttribute('font-weight','800');
    t2.textContent = `€ HT`;

    svg.appendChild(t1);
    svg.appendChild(t2);

    const legend = document.createElement('div');
    legend.className = 'legend';

    items
      .slice()
      .sort((a,b)=>b.value-a.value)
      .forEach(d => {
        const pct = total > 0 ? (d.value/total*100) : 0;
        const row = document.createElement('div');
        row.className = 'legRow';
        row.setAttribute('data-row-key', d.key);
        row.innerHTML = `
          <div class="legL">
            <span class="sw" style="background:${d._color}"></span>
            <span class="legName">${escapeHtml(d.name)}</span>
          </div>
          <div class="legVal">
            ${formatEUR(d.value)}
            <span style="color:${getVar('--muted')};font-weight:800">(${pct.toFixed(1)}%)</span>
            ${settings.showQty==='ON' ? `<span style="margin-left:8px;color:${getVar('--muted')};font-weight:850;font-size:12px">Qté: ${qtyText(d.qty)}</span>` : ''}
          </div>
        `;

        row.addEventListener('mouseenter', () => setHover(d.key));
        row.addEventListener('mouseleave', () => clearHover());

        if(onPick) row.addEventListener('click', () => onPick(d));
        legend.appendChild(row);
      });

    const right = document.createElement('div');
    right.appendChild(legend);

    const totalsWrap = document.createElement('div');
    totalsWrap.className = 'totals';
    totalsWrap.innerHTML = `
      <div class="totalBox">
        <div class="totalLabel">CA Total (hors TCG)</div>
        <div class="totalValue" style="color:${getVar('--pri2')}">${formatEUR(totals.sansTCG)} €</div>
      </div>
      <div class="totalBox">
        <div class="totalLabel">CA TOTAL GLOBAL</div>
        <div class="totalValue">${formatEUR(totals.total)} €</div>
      </div>
    `;
    right.appendChild(totalsWrap);

    bd.appendChild(svg);
    bd.appendChild(right);

    wrap.appendChild(bd);
    return wrap;
  }

  // ===== classification =====
  const TOP = {
    JEUX: "Jeux de société",
    KIDS: "Jeux enfants",
    PUZ: "Puzzles",
    CASSE: "Casse-têtes",
    JDR: "Jeux de rôles",
    ACC: "Accessoires",
    TCG: "TCG",
    EVT: "Événement",
    AUTRE: "Autre",
    PUZCASSE: "Puzzles & Casse-têtes"
  };

  function topLabelForKey(key){
    return key; // keys are already labels
  }

  function makeBucket(){
    return {
      totalsHT: new Map(),      // topKeyLabel -> total
      totalsQty: new Map(),     // topKeyLabel -> qty
      sub: new Map(),           // topKeyLabel -> Map(subKey -> {value, qty, hasQty})
      tcg: {                    // extra for tcg drilldown
        licenses: new Map(),    // licNorm -> {value, qty, hasQty}
        seriesByLicense: new Map() // licNorm -> Map(seriesName -> {value, qty, hasQty})
      },
      total: 0,
      totalQty: 0
    };
  }

  function bumpMap(map, key, add){
    map.set(key, (map.get(key) || 0) + add);
  }

  function addToSub(bucket, topKey, subKey, ht, qty){
    if(!bucket.sub.has(topKey)) bucket.sub.set(topKey, new Map());
    const m = bucket.sub.get(topKey);
    if(!m.has(subKey)) m.set(subKey, { value:0, qty:0, hasQty:false });
    const cur = m.get(subKey);
    cur.value += ht;
    if(qty !== null && qty !== undefined && Number.isFinite(qty)){
      cur.qty += qty;
      cur.hasQty = true;
    }
  }

  function addToTcg(bucket, licNorm, seriesName, ht, qty){
    if(!bucket.tcg.licenses.has(licNorm)) bucket.tcg.licenses.set(licNorm, { value:0, qty:0, hasQty:false });
    const lic = bucket.tcg.licenses.get(licNorm);
    lic.value += ht;
    if(qty !== null && qty !== undefined && Number.isFinite(qty)){
      lic.qty += qty;
      lic.hasQty = true;
    }

    if(!bucket.tcg.seriesByLicense.has(licNorm)) bucket.tcg.seriesByLicense.set(licNorm, new Map());
    const sm = bucket.tcg.seriesByLicense.get(licNorm);
    if(!sm.has(seriesName)) sm.set(seriesName, { value:0, qty:0, hasQty:false });
    const s = sm.get(seriesName);
    s.value += ht;
    if(qty !== null && qty !== undefined && Number.isFinite(qty)){
      s.qty += qty;
      s.hasQty = true;
    }
  }

  function classify(catName){
    const catNorm = normalize(catName);
    const lic = pickLicense(catNorm);
    const acc = isAccessory(catNorm);
    const evt = isEvent(catNorm);
    const other = isOther(catNorm);

    // Autre (technique)
    if(other){
      return { top: TOP.AUTRE, sub: catName, tcgLicense:null };
    }

    // Événements -> catégorie parent si activé
    if(settings.eventsStandalone === 'YES' && evt){
      return { top: TOP.EVT, sub: catName, tcgLicense:null };
    }

    // Jeux enfants
    if(isKids(catNorm)){
      return { top: TOP.KIDS, sub: TOP.KIDS, tcgLicense:null }; // tout regroupé en "Jeux enfants"
    }

    // Casse-têtes (inclut Perplexus, Smart Games)
    if(isCasse(catNorm)){
      const topKey = (settings.mergePuzzleCasse === 'YES') ? TOP.PUZCASSE : TOP.CASSE;
      return { top: topKey, sub: catName, tcgLicense:null };
    }

    // Puzzles (inclut Cavallini, Jours fériés)
    if(isPuzzle(catNorm)){
      const topKey = (settings.mergePuzzleCasse === 'YES') ? TOP.PUZCASSE : TOP.PUZ;
      return { top: topKey, sub: catName, tcgLicense:null };
    }

    // Jeux de rôles (selon param)
    if(isJdr(catNorm)){
      if(settings.jdrStandalone === 'YES'){
        return { top: TOP.JDR, sub: catName, tcgLicense:null };
      }
      // sinon => Jeux de société
    }

    // TCG (licence détectée)
    if(lic){
      // Accessoires TCG : soit dans la licence, soit dans Accessoires
      if(acc && settings.tcgAccessoriesInTcg !== 'YES'){
        return { top: TOP.ACC, sub: catName, tcgLicense:null };
      }
      return { top: TOP.TCG, sub: catName, tcgLicense: lic };
    }

    // Accessoires (non TCG)
    if(acc){
      return { top: TOP.ACC, sub: catName, tcgLicense:null };
    }

    // Jeux de dessin => Jeux de société (tombe ici)
    return { top: TOP.JEUX, sub: catName, tcgLicense:null };
  }

  function buildTopOrder(){
    const order = [
      TOP.JEUX,
      TOP.KIDS,
      (settings.mergePuzzleCasse === 'YES') ? TOP.PUZCASSE : TOP.PUZ,
      (settings.mergePuzzleCasse === 'YES') ? null : TOP.CASSE,
      (settings.jdrStandalone === 'YES') ? TOP.JDR : null,
      TOP.ACC,
      TOP.TCG,
      (settings.eventsStandalone === 'YES') ? TOP.EVT : null,
      TOP.AUTRE
    ].filter(Boolean);

    // Remove duplicates if merge is on
    return [...new Set(order)];
  }

  // ===== parsing / aggregation =====
  function addRow(bucket, r){
    bucket.total += r.ht;
    if(r.qty !== null && r.qty !== undefined && Number.isFinite(r.qty)) bucket.totalQty += r.qty;

    // totals per top
    bumpMap(bucket.totalsHT, r.top, r.ht);
    if(r.qty !== null && r.qty !== undefined && Number.isFinite(r.qty)) bumpMap(bucket.totalsQty, r.top, r.qty);

    // sub map
    addToSub(bucket, r.top, r.sub, r.ht, r.qty);

    // tcg drilldown
    if(r.top === TOP.TCG && r.license){
      addToTcg(bucket, r.license, r.sub, r.ht, r.qty);
    }
  }

  function calcSansTCG(bucket){
    const tcg = bucket.totalsHT.get(TOP.TCG) || 0;
    return bucket.total - tcg;
  }

  // ===== date label =====
  function updateDates(){
    const raw = els.raw.value || '';
    const range = extractDateRange(raw);
    const label = dateLabel(range);
    els.dateInfo.textContent = label;
    els.rightDate.textContent = label;
  }

  function parseAll(){
    const raw = els.raw.value || '';
    updateDates();

    const lines = raw.split(/\r?\n/);
    const rows = [];
    let used = 0, err = 0;

    debug = { used: [], err: [], ignored: [] };

    for(const line of lines){
      const l = (line||'').trim();
      if(!l){
        debug.ignored.push({reason:'Ligne vide', line});
        continue;
      }

      const ln = normalize(line);

      if(IGNORE_LINE_PATTERNS.some(p => ln.includes(p))){
        debug.ignored.push({reason:'Ligne de statut (à ignorer)', line});
        continue;
      }

      const boutiqueKey = detectBoutique(ln);
      if(!boutiqueKey){
        debug.ignored.push({reason:'Boutique non détectée', line});
        continue;
      }

      const ht = extractHTFromLine(line);
      if(ht === null){
        err++;
        debug.err.push({reason:'Montant HT introuvable', line});
        continue;
      }

      const qty = extractQtyFromLine(line);
      const cat = extractCategoryName(line);

      const cls = classify(cat);
      rows.push({
        boutiqueKey,
        top: cls.top,
        sub: cls.sub,
        category: cat,
        ht,
        qty,
        license: cls.tcgLicense,
        rawLine: line
      });
      used++;
      debug.used.push({reason:`OK → ${cls.top}`, line});
    }

    els.metaLines.textContent = String(lines.length);
    els.metaUsed.textContent  = String(used);
    els.metaErr.textContent   = String(err);

    const present = BOUTIQUES.filter(b => rows.some(r => r.boutiqueKey === b.key));
    const two = present.length >= 2;
    els.warnTwo.style.display = two ? 'block' : 'none';

    const byBoutique = {};
    for(const b of BOUTIQUES) byBoutique[b.key] = makeBucket();
    const global = makeBucket();

    for(const r of rows){
      addRow(byBoutique[r.boutiqueKey], r);
      addRow(global, r);
    }

    const activeKey = (!two && present.length===1) ? present[0].key : 'GLOBAL';

    parsed = { rows, present, two, activeKey, byBoutique, global };

    if(view.level !== 'dashboard') view = { level:'dashboard', category:null, tcgLicense:null, globalOnly: two };
    else view.globalOnly = two;

    render();
  }

  function currentBucket(){
    if(!parsed) return null;
    return parsed.activeKey === 'GLOBAL' ? parsed.global : parsed.byBoutique[parsed.activeKey];
  }

  function clearDyn(){
    els.rightBody.querySelectorAll('.dyn').forEach(n => n.remove());
  }

  function render(){
    clearDyn();
    clearHover();

    if(!parsed || !parsed.rows.length){
      els.rightTitle.textContent = 'Résultats';
      els.btnBack.style.display = 'none';
      const empty = document.createElement('div');
      empty.className = 'empty dyn';
      empty.innerHTML = 'Colle un export PrestaShop : les résultats apparaissent automatiquement.';
      els.rightBody.appendChild(empty);
      els.warnTwo.style.display = 'none';
      els.rightDate.textContent = els.dateInfo.textContent || '—';
      return;
    }

    els.btnBack.style.display = (view.level === 'dashboard') ? 'none' : 'inline-flex';

    if(view.level === 'dashboard') renderDashboard();
    else if(view.level === 'category') renderCategory();
    else if(view.level === 'tcgLicense') renderTcgLicense();

    els.warnTwo.style.display = parsed.two ? 'block' : 'none';
    els.rightDate.textContent = els.dateInfo.textContent || '—';
  }

  function renderDashboard(){
    const b = currentBucket();
    const title = parsed.activeKey === 'GLOBAL'
      ? 'GLOBAL (catégories)'
      : (BOUTIQUES.find(x=>x.key===parsed.activeKey)?.label || parsed.activeKey);
    els.rightTitle.textContent = title;

    const order = buildTopOrder();
    const data = order
      .map(k => ({
        key: k,
        name: k,
        value: b.totalsHT.get(k) || 0,
        qty: (b.totalsQty.get(k) ?? null)
      }))
      .filter(x => x.value > 0);

    const totals = { total: b.total, sansTCG: calcSansTCG(b) };

    const combo = renderComboPieAndTotals(
      data,
      'Répartition (catégories)',
      totals,
      (d) => {
        if(d.key === TOP.TCG){
          view = { level:'category', category: TOP.TCG, tcgLicense:null, globalOnly: parsed.two };
        } else {
          view = { level:'category', category: d.key, tcgLicense:null, globalOnly: parsed.two };
        }
        render();
      }
    );

    els.rightBody.appendChild(combo);
  }

  function renderCategory(){
    const b = currentBucket();
    const cat = view.category;

    els.rightTitle.textContent =
      `${parsed.activeKey === 'GLOBAL' ? 'GLOBAL' : (BOUTIQUES.find(x=>x.key===parsed.activeKey)?.label || parsed.activeKey)} — ${cat}`;

    if(cat === TOP.TCG){
      // Licences
      const entries = [...b.tcg.licenses.entries()]
        .map(([lic, obj]) => ({ key: lic, name: prettyLicense(lic), value: obj.value, qty: obj.hasQty ? obj.qty : null }))
        .sort((a,b)=> b.value - a.value);

      const totals = { total: b.total, sansTCG: calcSansTCG(b) };

      const combo = renderComboPieAndTotals(
        entries,
        `Répartition — TCG (licences)`,
        totals,
        (d) => { view = { level:'tcgLicense', category: TOP.TCG, tcgLicense:d.key, globalOnly: parsed.two }; render(); }
      );
      els.rightBody.appendChild(combo);
      return;
    }

    // Sous-catégories de la catégorie
    const subMap = b.sub.get(cat) || new Map();
    const entries = [...subMap.entries()]
      .map(([name, obj]) => ({ key:name, name, value: obj.value, qty: obj.hasQty ? obj.qty : null }))
      .sort((a,b)=> b.value - a.value);

    const totals = { total: b.total, sansTCG: calcSansTCG(b) };
    const combo = renderComboPieAndTotals(
      entries,
      `Répartition — ${cat} (toutes les sous-catégories)`,
      totals,
      null
    );
    els.rightBody.appendChild(combo);
  }

  function renderTcgLicense(){
    const b = currentBucket();
    const lic = view.tcgLicense;

    els.rightTitle.textContent =
      `${parsed.activeKey === 'GLOBAL' ? 'GLOBAL' : (BOUTIQUES.find(x=>x.key===parsed.activeKey)?.label || parsed.activeKey)} — TCG — ${prettyLicense(lic)}`;

    const seriesMap = b.tcg.seriesByLicense.get(lic) || new Map();
    const entries = [...seriesMap.entries()]
      .map(([name,obj]) => ({ key:name, name, value: obj.value, qty: obj.hasQty ? obj.qty : null }))
      .sort((a,b)=> b.value - a.value);

    const totals = { total: b.total, sansTCG: calcSansTCG(b) };
    const combo = renderComboPieAndTotals(
      entries,
      `Répartition — ${prettyLicense(lic)} (séries)`,
      totals,
      null
    );
    els.rightBody.appendChild(combo);
  }

  // ===== Back button =====
  els.btnBack.addEventListener('click', () => {
    if(view.level === 'tcgLicense') view = { level:'category', category: TOP.TCG, tcgLicense:null, globalOnly: parsed?.two || false };
    else if(view.level === 'category') view = { level:'dashboard', category:null, tcgLicense:null, globalOnly: parsed?.two || false };
    else view = { level:'dashboard', category:null, tcgLicense:null, globalOnly: parsed?.two || false };
    render();
  });

  // ===== tutoriel pages =====
  const tutorialPages = [
    { title: "1) Choisir la boutique", text: "Dans PrestaShop, sélectionne la boutique Pigalle OU Gambetta depuis un onglet (ex : Tableau de bord). L’app est prévue pour une boutique à la fois." },
    { title: "2) Accéder au rapport", text: "Va dans Commandes → Rapport Commandes TVA Bénéfices." },
    { title: "3) Paramétrer l’export", text: "Préférences d’export : Type de rapport = Catégories ; Format = html (souvent déjà sélectionné)." },
    { title: "4) Définir la période", text: "Filtres par Dates et Références : dans Par date de commande, choisis date début et date fin. Pour une analyse journalière : même date en début et fin." },
    { title: "5) Statuts à sélectionner", text: "Filtre par statuts de commande : tout décocher, puis cocher uniquement Store - Sale." },
    { title: "6) Exporter + copier", text: "Clique sur Exporter. Le tableau apparaît : fais Ctrl+A puis Ctrl+C sur la page du tableau." },
    { title: "7) Coller ici", text: "Reviens dans cette app : clique dans la zone de collage puis Ctrl+V. Les résultats s’affichent automatiquement." }
  ];
  let tutPage = 0;

  function renderTut(){
    const p = tutorialPages[tutPage];
    els.tutHead.textContent = p.title;
    els.tutContent.innerHTML = `
      <h3>${escapeHtml(p.title)}</h3>
      <p>${escapeHtml(p.text)}</p>
      <p class="muted" style="margin-top:10px;font-size:12px">
        Astuce : si 2 boutiques sont collées, l’app passe en mode GLOBAL (catégories uniquement).
      </p>
    `;
    els.tutIdx.textContent = String(tutPage+1);
    els.tutTotal.textContent = String(tutorialPages.length);
    els.tutPrev.disabled = tutPage === 0;
    els.tutNext.textContent = (tutPage === tutorialPages.length-1) ? 'Terminer' : 'Suivant';
  }
  function openTut(){ tutPage = 0; renderTut(); els.tutBg.style.display='flex'; els.tutBg.setAttribute('aria-hidden','false'); }
  function closeTut(){ els.tutBg.style.display='none'; els.tutBg.setAttribute('aria-hidden','true'); }
  els.btnTut.addEventListener('click', openTut);
  els.btnCloseTut.addEventListener('click', closeTut);
  els.tutBg.addEventListener('click', (e)=>{ if(e.target === els.tutBg) closeTut(); });
  els.tutPrev.addEventListener('click', ()=>{ if(tutPage>0){ tutPage--; renderTut(); } });
  els.tutNext.addEventListener('click', ()=>{ if(tutPage < tutorialPages.length-1){ tutPage++; renderTut(); } else closeTut(); });

  // ===== settings =====
  function setActivePair(noBtn, yesBtn, isYes){
    noBtn.classList.toggle('active', !isYes);
    yesBtn.classList.toggle('active', isYes);
  }
  function syncSettingsButtons(){
    setActivePair(els.qtyOff, els.qtyOn, settings.showQty==='ON');
    setActivePair(els.mergePCNo, els.mergePCYes, settings.mergePuzzleCasse==='YES');
    setActivePair(els.evtNo, els.evtYes, settings.eventsStandalone==='YES');
    setActivePair(els.jdrNo, els.jdrYes, settings.jdrStandalone==='YES');
    setActivePair(els.tcgAccNo, els.tcgAccYes, settings.tcgAccessoriesInTcg==='YES');
  }

  function openSet(){
    syncSettingsButtons();
    els.setBg.style.display = 'flex';
    els.setBg.setAttribute('aria-hidden','false');
  }
  function closeSet(){
    els.setBg.style.display = 'none';
    els.setBg.setAttribute('aria-hidden','true');
  }
  els.btnSettings.addEventListener('click', openSet);
  els.btnCloseSet.addEventListener('click', closeSet);
  els.setBg.addEventListener('click', (e)=>{ if(e.target === els.setBg) closeSet(); });

  function saveAndReparse(){
    localStorage.setItem('lgdj_qty', settings.showQty);
    localStorage.setItem('lgdj_merge_pc', settings.mergePuzzleCasse);
    localStorage.setItem('lgdj_evt', settings.eventsStandalone);
    localStorage.setItem('lgdj_jdr', settings.jdrStandalone);
    localStorage.setItem('lgdj_tcgacc', settings.tcgAccessoriesInTcg);
    closeSet();
    // Reparse to reclassify with new rules
    if((els.raw.value||'').trim()) parseAll();
    else render();
  }

  els.qtyOff.addEventListener('click', ()=>{ settings.showQty='OFF'; syncSettingsButtons(); saveAndReparse(); });
  els.qtyOn.addEventListener('click', ()=>{ settings.showQty='ON'; syncSettingsButtons(); saveAndReparse(); });

  els.mergePCNo.addEventListener('click', ()=>{ settings.mergePuzzleCasse='NO'; syncSettingsButtons(); saveAndReparse(); });
  els.mergePCYes.addEventListener('click', ()=>{ settings.mergePuzzleCasse='YES'; syncSettingsButtons(); saveAndReparse(); });

  els.evtNo.addEventListener('click', ()=>{ settings.eventsStandalone='NO'; syncSettingsButtons(); saveAndReparse(); });
  els.evtYes.addEventListener('click', ()=>{ settings.eventsStandalone='YES'; syncSettingsButtons(); saveAndReparse(); });

  els.jdrNo.addEventListener('click', ()=>{ settings.jdrStandalone='NO'; syncSettingsButtons(); saveAndReparse(); });
  els.jdrYes.addEventListener('click', ()=>{ settings.jdrStandalone='YES'; syncSettingsButtons(); saveAndReparse(); });

  els.tcgAccNo.addEventListener('click', ()=>{ settings.tcgAccessoriesInTcg='NO'; syncSettingsButtons(); saveAndReparse(); });
  els.tcgAccYes.addEventListener('click', ()=>{ settings.tcgAccessoriesInTcg='YES'; syncSettingsButtons(); saveAndReparse(); });

  // ===== Changelog =====
  function openVer(){
    els.verContent.innerHTML = `
      <h3 style="margin:0 0 10px 0">${VERSION}</h3>
      <div style="line-height:1.55">
        <ul>
          <li>Nouvelles catégories : Jeux enfants, Puzzles, Casse-têtes, Jeux de rôles, Autre</li>
          <li>Jeux enfants : regroupe “Jeux X ans” + “Défis Nature”</li>
          <li>Autre : Accueil, Catégorie supprimée, Acompte, Livraison, Totaux(xxx)…</li>
          <li>Paramètres : fusion Puzzles/Casse-têtes, événements en parent, JDR séparé, accessoires TCG dans leur TCG</li>
          <li>Correction : “jeux de dessin” reste en Jeux de société (par défaut)</li>
        </ul>
      </div>
    `;
    els.verBg.style.display='flex';
    els.verBg.setAttribute('aria-hidden','false');
  }
  function closeVer(){
    els.verBg.style.display='none';
    els.verBg.setAttribute('aria-hidden','true');
  }
  els.btnVer.addEventListener('click', openVer);
  els.btnCloseVer.addEventListener('click', closeVer);
  els.verBg.addEventListener('click', (e)=>{ if(e.target === els.verBg) closeVer(); });

  // ===== Stats debug =====
  let activeTab = 'used';
  function statsText(tab){
    const arr = debug[tab] || [];
    const head =
      tab === 'used' ? 'Lignes utilisées (prises en compte)' :
      tab === 'err' ? 'Erreurs (boutique détectée mais montant HT introuvable)' :
      'Ignorées (non pertinentes / hors tableau)';
    els.statsHint.textContent = `${head} — ${arr.length}`;
    return arr.map((x,i)=>`#${i+1} • ${x.reason}\n${x.line}`).join("\n\n");
  }
  function renderStats(){
    els.statsBox.textContent = parsed ? (statsText(activeTab) || '—') : 'Analyse un export pour afficher les détails.';
  }
  function openStats(){
    activeTab = 'used';
    document.querySelectorAll('.tabBtn').forEach(t=>t.classList.toggle('active', t.dataset.tab===activeTab));
    renderStats();
    els.statsBg.style.display='flex';
    els.statsBg.setAttribute('aria-hidden','false');
  }
  function closeStats(){
    els.statsBg.style.display='none';
    els.statsBg.setAttribute('aria-hidden','true');
  }

  els.btnStats.addEventListener('click', openStats);
  els.btnCloseStats.addEventListener('click', closeStats);
  els.statsBg.addEventListener('click', (e)=>{ if(e.target === els.statsBg) closeStats(); });

  document.querySelectorAll('.tabBtn').forEach(t=>{
    t.addEventListener('click', ()=>{
      activeTab = t.dataset.tab;
      document.querySelectorAll('.tabBtn').forEach(x=>x.classList.toggle('active', x.dataset.tab===activeTab));
      renderStats();
    });
  });

  els.btnCopyStats.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(els.statsBox.textContent || '');
      els.btnCopyStats.textContent = 'Copié';
      setTimeout(()=> els.btnCopyStats.textContent='Copier', 900);
    } catch {
      const ta = document.createElement('textarea');
      ta.value = els.statsBox.textContent || '';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      els.btnCopyStats.textContent = 'Copié';
      setTimeout(()=> els.btnCopyStats.textContent='Copier', 900);
    }
  });

  // Esc closes modals
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      closeTut();
      closeSet();
      closeVer();
      closeStats();
    }
  });

  // ===== Input: auto-parse (debounce) =====
  let parseTimer = null;
  function scheduleParse(){
    if(parseTimer) clearTimeout(parseTimer);
    parseTimer = setTimeout(()=> {
      parseTimer = null;
      parseAll();
    }, 140);
  }
  els.raw.addEventListener('input', scheduleParse);
  els.raw.addEventListener('paste', scheduleParse);

  // Coller button
  els.btnPaste.addEventListener('click', async ()=>{
    els.raw.focus();
    try{
      const txt = await navigator.clipboard.readText();
      if(txt){
        els.raw.value = txt;
        scheduleParse();
      }
    } catch {}
  });

  // Clear
  els.btnClear.addEventListener('click', () => {
    els.raw.value = '';
    parsed = null;
    view = { level:'dashboard', category:null, tcgLicense:null, globalOnly:false };
    debug = { used: [], err: [], ignored: [] };
    els.metaLines.textContent = '0';
    els.metaUsed.textContent = '0';
    els.metaErr.textContent = '0';
    els.warnTwo.style.display = 'none';
    els.dateInfo.textContent = '—';
    els.rightDate.textContent = '—';
    render();
    els.raw.focus();
  });

  // init
  els.btnVer.textContent = VERSION;
  els.ver2.textContent = VERSION;
  syncSettingsButtons();
  render();
</script>
</body>
</html>

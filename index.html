<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LGDJ — Extracteur CA (Offline)</title>
  <style>
    :root{
      --ver: "v0.6.1";

      --bg0:#0b1020;
      --bg1:#0c1426;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(0,0,0,.20);
      --text:#eef2ff;
      --muted:#aab3c7;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 55px rgba(0,0,0,.45);

      --pri:#4f46e5;
      --good:#22c55e;
      --warn:#f59e0b;

      --pieBase:#60a5fa;

      --r:18px;
      --btn: rgba(255,255,255,.08);
      --btnH: rgba(255,255,255,.12);
      --chip: rgba(255,255,255,.06);
      --input: rgba(0,0,0,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(79,70,229,.20), transparent 60%),
        radial-gradient(900px 520px at 80% 14%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    .app{height:100vh; display:flex; flex-direction:column;}

    .topbar{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}

    .brand{display:flex;align-items:center;gap:10px;font-weight:950;letter-spacing:.2px}
    .logo{
      width:36px;height:36px;border-radius:14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(79,70,229,.18), rgba(34,197,94,.10));
      display:grid;place-items:center;
      box-shadow: var(--shadow);
    }
    .brandTitle{display:flex;flex-direction:column;line-height:1.05}

    .verBtn{
      margin-top:2px;
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      background:transparent;
      border:none;
      padding:0;
      text-align:left;
      cursor:pointer;
    }
    .verBtn:hover{color:var(--text)}

    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .chipBtn{
      cursor:pointer;
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background: var(--chip);
      padding:6px 10px;border-radius:999px;
      white-space:nowrap;
      font-weight:900;
    }
    .chipBtn:hover{background: rgba(255,255,255,.10); color:var(--text)}

    button{
      cursor:pointer;
      border:1px solid var(--line);
      background: var(--btn);
      color:var(--text);
      padding:8px 10px;
      border-radius: 12px;
      font-weight:900;
      font-size:12px;
      transition: background .15s ease, transform .04s ease;
      user-select:none;
    }
    button:hover{background:var(--btnH)}
    button:active{transform: translateY(1px)}

    .btnTutor{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .btnTutor:hover{background: rgba(34,197,94,.18)}

    .btnGear{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10)}
    .btnGear:hover{background: rgba(245,158,11,.16)}

    .main{
      flex:1;
      padding:0 14px 14px;
      display:grid;
      grid-template-columns: 300px 1fr; /* gauche plus slim */
      gap:12px;
      min-height:0;
    }
    @media(max-width:980px){
      .main{grid-template-columns:1fr;}
    }

    .panel{
      border:1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius: var(--r);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(10px);
    }

    .panel .hd{
      padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background: var(--panel2);
    }

    .hdTitle{font-weight:950;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .bd{padding:12px; min-height:0;}

    textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--input);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:13px;
      line-height:1.35;
      resize:none;
      height: calc(100vh - 160px);
      overflow:auto;
    }

    .hint{color:var(--muted);font-size:12px;font-weight:850;line-height:1.35}

    /* OUTPUT */
    .rightScroll{height:100%;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px;}

    .alert{
      border:1px solid rgba(245,158,11,.40);
      background: rgba(245,158,11,.10);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:850;
      font-size:12px;
      display:none;
    }

    /* Single result card (pie + list) */
    .card{
      border-radius: var(--r);
      border:1px solid var(--line);
      background: var(--panel);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      backdrop-filter: blur(10px);
    }
    .cardHd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;background: var(--panel2);}
    .crumb{display:flex;align-items:center;gap:8px;font-weight:980;min-width:0}
    .crumb span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .cardBd{padding:12px 14px; display:grid; grid-template-columns: 200px 1fr; gap:14px; align-items:start; min-height:0;}
    @media(max-width:980px){.cardBd{grid-template-columns:1fr}}

    .legend{display:grid;gap:8px; min-height:0; max-height: 38vh; overflow:auto; padding-right:6px;}
    .legRow{display:flex;align-items:center;justify-content:space-between;gap:10px; padding:8px 0; border-bottom:1px dashed rgba(125,125,155,.22); cursor:pointer;}
    .legRow:last-child{border-bottom:none}
    .legRow:hover .legName{color:var(--text)}

    .legL{display:flex;align-items:center;gap:10px; min-width:0;}
    .sw{width:10px;height:10px;border-radius:4px; flex:0 0 auto;}
    .legName{color:var(--muted);font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .legVal{font-weight:950; white-space:nowrap;}

    .totals{display:grid;gap:10px;margin-top:10px;}
    .totalBox{
      border-radius: 14px;
      padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid var(--line);
      background: var(--panel2);
    }
    .totalLabel{font-weight:980;letter-spacing:.15px}
    .totalValue{font-weight:980;font-size:18px}

    .divider{height:1px;background: var(--line);}

    .listWrap{padding:10px 14px; min-height:0;}
    .listTitle{font-weight:980; color:var(--text); margin:0 0 6px 0; font-size:13px;}
    .listBd{overflow:auto; min-height:0; max-height: 38vh; padding-right:6px;}

    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px dashed rgba(125,125,155,.22);cursor:pointer;}
    .item:last-child{border-bottom:none}
    .item:hover .name{color:var(--text)}

    .name{color:var(--muted); font-weight:950; display:flex; align-items:center; gap:10px; min-width:0;}
    .name span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .marker{width:18px;height:18px;border-radius:8px;border:1px solid var(--line);background: rgba(255,255,255,.10);display:grid;place-items:center;font-size:12px;flex:0 0 auto;}

    .amt{font-weight:980; white-space:nowrap;}

    .empty{padding:22px;color:var(--muted);text-align:center;font-weight:900}

    /* Modal (fixed size, no layout jump) */
    .modalBg{position:fixed;inset:0;background: rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;}
    .modal{width: min(880px, 100%); height: min(620px, 90vh); overflow:hidden; border-radius: 18px;border:1px solid var(--line);background: var(--panel);box-shadow: var(--shadow);backdrop-filter: blur(12px);display:flex;flex-direction:column;}
    .modal .mhd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;background: var(--panel2);}
    .modal .mbd{padding:14px 16px; overflow:auto; flex:1;}

    .pager{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:14px;}
    .pageTitle{font-weight:980;font-size:16px;margin:0 0 6px 0}
    .pageText{color:var(--text); line-height:1.55}
    .muted{color:var(--muted)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background: rgba(255,255,255,.06);font-weight:900;font-size:12px;cursor:pointer}
    .tab.active{background: rgba(79,70,229,.16);border-color: rgba(79,70,229,.35)}

    .codeBox{border:1px solid var(--line);background: rgba(0,0,0,.22);border-radius:14px;padding:10px 12px;white-space:pre-wrap;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;line-height:1.45;height: 100%; overflow:auto;}

    .slice{cursor:pointer; transition: opacity .15s ease;}
    .slice:hover{opacity:.86}

    .foot{padding:0 14px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;color:var(--muted);font-size:11px;font-weight:800;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .contact{color:var(--muted);font-size:11px;font-weight:900}

    select{border-radius:12px;border:1px solid var(--line);background: rgba(0,0,0,.18);color:var(--text);padding:10px 10px;font-weight:900;outline:none}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 19V5" stroke="currentColor" stroke-opacity=".9" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 19H20" stroke="currentColor" stroke-opacity=".9" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 16V11" stroke="currentColor" stroke-opacity=".85" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 16V8" stroke="currentColor" stroke-opacity=".85" stroke-width="2" stroke-linecap="round"/>
            <path d="M16 16V13" stroke="currentColor" stroke-opacity=".85" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="brandTitle">
          <div>Extracteur CA</div>
          <button class="verBtn" id="btnVer">v0.6.1</button>
        </div>
      </div>

      <div class="actions">
        <button class="chipBtn" id="btnStats">Lues: <span class="mono" id="metaLines">0</span> • Utilisées: <span class="mono" id="metaUsed">0</span> • Erreurs: <span class="mono" id="metaErr">0</span></button>
        <button class="btnTutor" id="btnTut">Tutoriel</button>
        <button class="btnGear" id="btnSettings">Paramètres</button>
      </div>
    </div>

    <div class="main">
      <!-- INPUT (slim) -->
      <section class="panel">
        <div class="hd">
          <div class="hdTitle">Coller le tableau</div>
          <div class="actions">
            <button id="btnPaste">Coller</button>
            <button id="btnClear">Vider</button>
          </div>
        </div>
        <div class="bd" style="display:flex;flex-direction:column;gap:10px;min-height:0">
          <div class="hint">Sur PrestaShop : Ctrl+A → Ctrl+C sur le tableau, puis ici “Coller”. (Sinon Ctrl+V directement dans la zone.)</div>
          <textarea id="raw" placeholder="Colle ici…"></textarea>
        </div>
      </section>

      <!-- OUTPUT -->
      <section class="panel">
        <div class="hd">
          <div class="hdTitle" id="rightTitle">Résultats</div>
          <div class="actions">
            <button id="btnBack" style="display:none">Retour</button>
          </div>
        </div>
        <div class="bd" style="padding:0">
          <div class="rightScroll" id="rightBody">
            <div class="alert" id="warnTwo">⚠️ Deux boutiques détectées. Affichage GLOBAL (catégories uniquement) — détails boutiques désactivés.</div>
          </div>
        </div>
      </section>
    </div>

    <div class="foot">
      <div class="mono">LGDJ — <span id="ver2">v0.6.1</span></div>
      <div class="contact">Si problème ou suggestion d’amélioration : contacter Zao</div>
      <div>Offline • Drilldown • HT</div>
    </div>
  </div>

  <!-- Tutoriel modal (fixed size) -->
  <div class="modalBg" id="tutBg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" aria-label="Tutoriel">
      <div class="mhd">
        <div style="font-weight:980">Tutoriel</div>
        <button id="btnCloseTut">Fermer</button>
      </div>
      <div class="mbd">
        <div id="tutContent"></div>
        <div class="pager">
          <button id="tutPrev">Précédent</button>
          <div class="muted"><span id="tutIdx">1</span>/<span id="tutTotal">1</span></div>
          <button id="tutNext" style="border-color: rgba(79,70,229,.35); background: rgba(79,70,229,.14)">Suivant</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings modal (no HT/TTC) -->
  <div class="modalBg" id="setBg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" aria-label="Paramètres">
      <div class="mhd">
        <div style="font-weight:980">Paramètres</div>
        <button id="btnCloseSet">Fermer</button>
      </div>
      <div class="mbd">
        <h3 class="pageTitle">Affichage</h3>
        <div class="pageText muted">L’app travaille en <b>HT uniquement</b>.</div>

        <div style="margin-top:14px">
          <div class="pageText" style="font-weight:950;margin-bottom:8px">Quantités</div>
          <select id="showQty" style="width:100%">
            <option value="OFF">Masquées</option>
            <option value="ON">Afficher</option>
          </select>
          <div class="muted" style="margin-top:6px;font-size:12px">Si la colonne Quantité n’est pas présente, l’app affiche “—”.</div>
        </div>

        <div class="pager" style="justify-content:flex-end">
          <button id="btnSaveSet" style="border-color: rgba(79,70,229,.35); background: rgba(79,70,229,.14)">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Version / Changelog modal -->
  <div class="modalBg" id="verBg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" aria-label="Changelog">
      <div class="mhd">
        <div style="font-weight:980">Changelog</div>
        <button id="btnCloseVer">Fermer</button>
      </div>
      <div class="mbd" id="verContent"></div>
    </div>
  </div>

  <!-- Stats debug modal -->
  <div class="modalBg" id="statsBg" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" aria-label="Détails des lignes">
      <div class="mhd">
        <div style="font-weight:980">Détails des lignes</div>
        <button id="btnCloseStats">Fermer</button>
      </div>
      <div class="mbd" style="display:flex;flex-direction:column;gap:12px;min-height:0">
        <div class="tabs">
          <div class="tab active" data-tab="used">Utilisées</div>
          <div class="tab" data-tab="err">Erreurs</div>
          <div class="tab" data-tab="ignored">Ignorées</div>
        </div>
        <div class="muted" id="statsHint" style="font-size:12px"></div>
        <div class="codeBox" id="statsBox">—</div>
        <div class="pager" style="justify-content:flex-end;margin-top:0">
          <button id="btnCopyStats" style="border-color: rgba(79,70,229,.35); background: rgba(79,70,229,.14)">Copier</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const VERSION = "v0.6.1";

  // Licences (non affichées) — tu m'enverras les ajouts quand nécessaire
  const TCG_LICENSES = [
    "Pokémon","Lorcana","One Piece","Magic","Altered","Flesh and Blood",
    "Star Wars Unlimited","Riftbound","Yu-Gi-Oh","Naruto"
  ];

  const ACCESSORY_KEYWORDS = [
    "accessoire","accessoires","protege","protège","sleeve","deck box","classeur","portfolio",
    "des","dés","piste","pistes","protections acryliques","grenier ludique","booknooks",
    "produits derives","produits dérivés","tapis"
  ];

  const BOUTIQUES = [
    { key: "GAMBETTA", label: "LGDJ Gambetta", needles: ["lgdj gambetta","gambetta"] },
    { key: "PIGALLE", label: "LGDJ Pigalle", needles: ["lgdj pigalle","pigalle"] }
  ];

  const el = (id) => document.getElementById(id);

  const els = {
    metaLines: el('metaLines'), metaUsed: el('metaUsed'), metaErr: el('metaErr'),

    raw: el('raw'),
    btnPaste: el('btnPaste'),
    btnClear: el('btnClear'),
    btnBack: el('btnBack'),

    rightTitle: el('rightTitle'), rightBody: el('rightBody'),
    warnTwo: el('warnTwo'),

    // tutoriel
    btnTut: el('btnTut'), tutBg: el('tutBg'), btnCloseTut: el('btnCloseTut'),
    tutContent: el('tutContent'), tutPrev: el('tutPrev'), tutNext: el('tutNext'),
    tutIdx: el('tutIdx'), tutTotal: el('tutTotal'),

    // settings
    btnSettings: el('btnSettings'), setBg: el('setBg'), btnCloseSet: el('btnCloseSet'),
    showQty: el('showQty'), btnSaveSet: el('btnSaveSet'),

    // version
    btnVer: el('btnVer'), verBg: el('verBg'), btnCloseVer: el('btnCloseVer'), verContent: el('verContent'),

    // stats
    btnStats: el('btnStats'), statsBg: el('statsBg'), btnCloseStats: el('btnCloseStats'),
    statsHint: el('statsHint'), statsBox: el('statsBox'), btnCopyStats: el('btnCopyStats'),
  };

  // Persisted settings
  const settings = {
    showQty: (localStorage.getItem('lgdj_qty') || 'OFF')
  };
  els.showQty.value = settings.showQty;

  let parsed = null;
  let view = { level: 'dashboard', category: null, tcgLicense: null, globalOnly: false };
  let debug = { used: [], err: [], ignored: [] };

  function normalize(s){
    return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  }

  function parseMoneyToNumber(token){
    let t = token.replace(/[^0-9,.-]/g,"").replace(/\s+/g,"").trim();
    if(!t) return null;
    const hasComma = t.includes(",");
    const hasDot = t.includes(".");
    let cleaned = t;
    if(hasComma && hasDot){
      const lc = cleaned.lastIndexOf(",");
      const ld = cleaned.lastIndexOf(".");
      if(ld > lc) cleaned = cleaned.replace(/,/g,"");
      else cleaned = cleaned.replace(/\./g,"").replace(/,/g,".");
    } else if(hasComma && !hasDot){
      cleaned = cleaned.replace(/,/g,".");
    }
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : null;
  }

  function extractHTFromLine(line){
    const moneyTokens = [...line.matchAll(/(-?\d[\d\s.,]*)(\$|€)/g)].map(m => m[0]);
    if(moneyTokens.length === 0) return null;
    const nums = moneyTokens.map(parseMoneyToNumber).filter(v => typeof v === 'number');
    if(nums.length >= 3) return nums[2];
    return nums.length ? nums[nums.length - 1] : null;
  }

  function extractQtyFromLine(line){
    const parts = line.split("\t").map(p=>p.trim());
    if(parts.length >= 5){
      const q = Number(parts[3]);
      return Number.isFinite(q) ? q : null;
    }
    return null;
  }

  function extractCategoryName(line){
    const parts = line.split("\t").map(p=>p.trim()).filter(Boolean);
    if(parts.length >= 4) return parts[2];
    const m = line.match(/LGDJ\s+(?:Gambetta|Pigalle)\s+(?:\d+\s+)?(.+?)\s+\d+\s+0\$/i);
    if(m && m[1]) return m[1].trim();
    return line.replace(/^LGDJ\s+(Gambetta|Pigalle)\s*/i,"").slice(0,80).trim();
  }

  function detectBoutique(lineNorm){
    for(const b of BOUTIQUES){
      if(b.needles.some(n => lineNorm.includes(n))) return b.key;
    }
    return null;
  }

  function isAccessory(catNorm){
    return ACCESSORY_KEYWORDS.some(k => catNorm.includes(normalize(k)));
  }

  function pickLicense(catNorm, tcgNeedlesNorm){
    for(const lic of tcgNeedlesNorm){
      if(lic && catNorm.includes(lic)) return lic;
    }
    return null;
  }

  function escapeHtml(s){
    return (s||'').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function formatEUR(n){
    const v = Number.isFinite(n) ? n : 0;
    return v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  // ----- Color utilities -----
  function hexToRgb(hex){
    const h = hex.replace('#','').trim();
    const full = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
    const n = parseInt(full, 16);
    return { r: (n>>16)&255, g: (n>>8)&255, b: n&255 };
  }
  function rgbToHex(r,g,b){
    const to = (x)=> x.toString(16).padStart(2,'0');
    return `#${to(r)}${to(g)}${to(b)}`;
  }
  function mix(a,b,t){ return Math.round(a + (b-a)*t); }
  function shadeHex(baseHex, t){
    const base = hexToRgb(baseHex);
    const dark = { r: 20, g: 30, b: 55 };
    const light = { r: 235, g: 242, b: 255 };
    if(t < 0.5){
      const tt = t/0.5;
      return rgbToHex(mix(dark.r, base.r, tt), mix(dark.g, base.g, tt), mix(dark.b, base.b, tt));
    } else {
      const tt = (t-0.5)/0.5;
      return rgbToHex(mix(base.r, light.r, tt), mix(base.g, light.g, tt), mix(base.b, light.b, tt));
    }
  }
  function getVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  // ===== pie svg =====
  function polarToCartesian(cx, cy, r, angle){
    const rad = (angle - 90) * Math.PI / 180.0;
    return { x: cx + (r * Math.cos(rad)), y: cy + (r * Math.sin(rad)) };
  }
  function arcPath(cx, cy, r, startAngle, endAngle){
    const start = polarToCartesian(cx, cy, r, endAngle);
    const end = polarToCartesian(cx, cy, r, startAngle);
    const largeArc = endAngle - startAngle <= 180 ? 0 : 1;
    return ['M', cx, cy,'L', start.x, start.y,'A', r, r, 0, largeArc, 0, end.x, end.y,'Z'].join(' ');
  }

  function buildSingleCard({title, listTitle, data, totals, onPick}){
    const total = data.reduce((a,b)=>a + (b.value||0), 0);

    const wrap = document.createElement('div');
    wrap.className = 'card dyn';

    const hd = document.createElement('div');
    hd.className = 'cardHd';
    hd.innerHTML = `<div class="crumb"><span>${escapeHtml(title)}</span></div>`;
    wrap.appendChild(hd);

    const bd = document.createElement('div');
    bd.className = 'cardBd';

    const size = 200;
    const cx = size/2;
    const cy = size/2;
    const r = 88;

    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('width', String(size));
    svg.setAttribute('height', String(size));
    svg.setAttribute('viewBox', `0 0 ${size} ${size}`);

    const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
    bg.setAttribute('cx', cx);
    bg.setAttribute('cy', cy);
    bg.setAttribute('r', r);
    bg.setAttribute('fill', getVar('--panel2'));
    bg.setAttribute('stroke', getVar('--line'));
    bg.setAttribute('stroke-width', '1');
    svg.appendChild(bg);

    const base = getVar('--pieBase') || '#60a5fa';
    const items = data.filter(d => d.value > 0);

    let angle = 0;
    items.forEach((d, i) => {
      const slice = total > 0 ? (d.value / total) * 360 : 0;
      const start = angle;
      const end = angle + slice;
      angle = end;

      const t = items.length <= 1 ? 0.6 : (0.25 + (i/(items.length-1))*0.6);
      const color = shadeHex(base, t);
      d._color = color;

      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', arcPath(cx, cy, r, start, end));
      path.setAttribute('fill', color);
      path.setAttribute('stroke', 'rgba(0,0,0,.12)');
      path.setAttribute('stroke-width', '1');
      path.classList.add('slice');
      if(onPick) path.addEventListener('click', () => onPick(d));
      svg.appendChild(path);
    });

    const hole = document.createElementNS('http://www.w3.org/2000/svg','circle');
    hole.setAttribute('cx', cx);
    hole.setAttribute('cy', cy);
    hole.setAttribute('r', 50);
    hole.setAttribute('fill', getVar('--bg0'));
    hole.setAttribute('stroke', getVar('--line'));
    hole.setAttribute('stroke-width', '1');
    svg.appendChild(hole);

    const t1 = document.createElementNS('http://www.w3.org/2000/svg','text');
    t1.setAttribute('x', cx);
    t1.setAttribute('y', cy - 4);
    t1.setAttribute('text-anchor','middle');
    t1.setAttribute('fill', getVar('--text'));
    t1.setAttribute('font-size','13');
    t1.setAttribute('font-weight','900');
    t1.textContent = formatEUR(total);

    const t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
    t2.setAttribute('x', cx);
    t2.setAttribute('y', cy + 16);
    t2.setAttribute('text-anchor','middle');
    t2.setAttribute('fill', getVar('--muted'));
    t2.setAttribute('font-size','10');
    t2.setAttribute('font-weight','800');
    t2.textContent = `€ HT`;

    svg.appendChild(t1);
    svg.appendChild(t2);

    const right = document.createElement('div');

    const legend = document.createElement('div');
    legend.className = 'legend';

    items
      .slice()
      .sort((a,b)=>b.value-a.value)
      .forEach(d => {
        const pct = total > 0 ? (d.value/total*100) : 0;
        const row = document.createElement('div');
        row.className = 'legRow';
        row.innerHTML = `
          <div class="legL">
            <span class="sw" style="background:${d._color}"></span>
            <span class="legName">${escapeHtml(d.name)}</span>
          </div>
          <div class="legVal">${formatEUR(d.value)} <span style="color:${getVar('--muted')};font-weight:800">(${pct.toFixed(1)}%)</span></div>
        `;
        if(onPick) row.addEventListener('click', () => onPick(d));
        legend.appendChild(row);
      });

    right.appendChild(legend);

    const totalsWrap = document.createElement('div');
    totalsWrap.className = 'totals';
    totalsWrap.innerHTML = `
      <div class="totalBox">
        <div class="totalLabel">CA Total (sans TCG)</div>
        <div class="totalValue" style="color:${getVar('--good')}">${formatEUR(totals.sansTCG)} €</div>
      </div>
      <div class="totalBox">
        <div class="totalLabel">CA TOTAL GLOBAL</div>
        <div class="totalValue">${formatEUR(totals.total)} €</div>
      </div>
    `;
    right.appendChild(totalsWrap);

    bd.appendChild(svg);
    bd.appendChild(right);
    wrap.appendChild(bd);

    // list inside the same card
    const div = document.createElement('div');
    div.className = 'divider';
    wrap.appendChild(div);

    const lw = document.createElement('div');
    lw.className = 'listWrap';
    lw.innerHTML = `<div class="listTitle">${escapeHtml(listTitle)}</div>`;

    const lb = document.createElement('div');
    lb.className = 'listBd';

    if(data.length === 0){
      lb.innerHTML = `<div class="empty">Aucun élément</div>`;
    } else {
      const sorted = data.slice().sort((a,b)=>b.value-a.value);
      sorted.forEach(it => {
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div class="name"><span class="marker">›</span><span>${escapeHtml(it.name)}</span></div>
          <div class="amt">${formatEUR(it.value)} €</div>
        `;
        if(onPick) row.addEventListener('click', ()=> onPick(it));
        lb.appendChild(row);
      });
    }

    lw.appendChild(lb);
    wrap.appendChild(lw);

    return wrap;
  }

  function clearDyn(){
    els.rightBody.querySelectorAll('.dyn').forEach(n => n.remove());
  }

  // ===== parse =====
  function makeBucket(){
    return {
      totalsHT: { Jeux:0, Accessoires:0, TCG:0, total:0, sansTCG:0 },
      sub: {
        Jeux: new Map(),
        Accessoires: new Map(),
        TCG: { licenses: new Map(), seriesByLicense: new Map() }
      }
    };
  }
  function addToMap(map, key, ht){
    if(!map.has(key)) map.set(key, { value:0 });
    map.get(key).value += ht;
  }
  function addRow(bucket, r){
    bucket.totalsHT.total += r.ht;
    if(r.top === 'Jeux'){
      bucket.totalsHT.Jeux += r.ht;
      addToMap(bucket.sub.Jeux, r.category, r.ht);
    } else if(r.top === 'Accessoires'){
      bucket.totalsHT.Accessoires += r.ht;
      addToMap(bucket.sub.Accessoires, r.category, r.ht);
    } else {
      bucket.totalsHT.TCG += r.ht;
      const lic = r.license || 'tcg';
      addToMap(bucket.sub.TCG.licenses, lic, r.ht);
      if(!bucket.sub.TCG.seriesByLicense.has(lic)) bucket.sub.TCG.seriesByLicense.set(lic, new Map());
      addToMap(bucket.sub.TCG.seriesByLicense.get(lic), r.category, r.ht);
    }
  }

  function parseAll(){
    const raw = (els.raw.value || '').trim();
    if(!raw){
      parsed = null;
      view = { level:'dashboard', category:null, tcgLicense:null, globalOnly:false };
      els.metaLines.textContent = '0';
      els.metaUsed.textContent  = '0';
      els.metaErr.textContent   = '0';
      debug = { used: [], err: [], ignored: [] };
      render();
      return;
    }

    const lines = raw.split(/\r?\n/);
    const tcgNeedlesNorm = TCG_LICENSES.map(s => normalize(s));

    const rows = [];
    let used = 0, err = 0;
    debug = { used: [], err: [], ignored: [] };

    for(const line of lines){
      const l = (line||'').trim();
      if(!l){ debug.ignored.push({reason:'Ligne vide', line}); continue; }

      const ln = normalize(line);
      const boutiqueKey = detectBoutique(ln);
      if(!boutiqueKey){ debug.ignored.push({reason:'Boutique non détectée', line}); continue; }

      const ht = extractHTFromLine(line);
      if(ht === null){ err++; debug.err.push({reason:'Montant HT introuvable', line}); continue; }

      const qty = extractQtyFromLine(line);
      const cat = extractCategoryName(line);
      const catNorm = normalize(cat);

      const license = pickLicense(catNorm, tcgNeedlesNorm);
      const tcg = !!license;
      const acc = !tcg && isAccessory(catNorm);
      const top = tcg ? 'TCG' : (acc ? 'Accessoires' : 'Jeux');

      rows.push({ boutiqueKey, top, category: cat, ht, qty, license, rawLine: line });
      used++;
      debug.used.push({reason:'OK', line});
    }

    els.metaLines.textContent = String(lines.length);
    els.metaUsed.textContent  = String(used);
    els.metaErr.textContent   = String(err);

    const present = BOUTIQUES.filter(b => rows.some(r => r.boutiqueKey === b.key));
    const two = present.length >= 2;

    const byBoutique = {};
    for(const b of BOUTIQUES){ byBoutique[b.key] = makeBucket(); }
    const global = makeBucket();

    for(const r of rows){
      addRow(byBoutique[r.boutiqueKey], r);
      addRow(global, r);
    }

    for(const k of Object.keys(byBoutique)) byBoutique[k].totalsHT.sansTCG = byBoutique[k].totalsHT.total - byBoutique[k].totalsHT.TCG;
    global.totalsHT.sansTCG = global.totalsHT.total - global.totalsHT.TCG;

    const activeKey = (!two && present.length===1) ? present[0].key : 'GLOBAL';

    parsed = { rows, present, two, activeKey, byBoutique, global };
    view = { level:'dashboard', category:null, tcgLicense:null, globalOnly: two };
    render();
  }

  function currentBucket(){
    if(!parsed) return null;
    if(parsed.activeKey === 'GLOBAL') return parsed.global;
    return parsed.byBoutique[parsed.activeKey];
  }

  function render(){
    clearDyn();

    if(!parsed){
      els.rightTitle.textContent = 'Résultats';
      els.btnBack.style.display = 'none';
      els.warnTwo.style.display = 'none';
      const empty = document.createElement('div');
      empty.className = 'empty dyn';
      empty.innerHTML = 'Colle un export : l’analyse se lance automatiquement.';
      els.rightBody.appendChild(empty);
      return;
    }

    els.btnBack.style.display = (view.level === 'dashboard') ? 'none' : 'inline-flex';
    els.warnTwo.style.display = parsed.two ? 'block' : 'none';

    if(view.level === 'dashboard') renderDashboard();
    else if(view.level === 'category') renderCategory();
    else if(view.level === 'tcgLicense') renderTcgLicense();
  }

  function renderDashboard(){
    const b = currentBucket();
    const title = parsed.activeKey === 'GLOBAL' ? 'GLOBAL (catégories)' : (BOUTIQUES.find(x=>x.key===parsed.activeKey)?.label || parsed.activeKey);
    els.rightTitle.textContent = title;

    const totals = { total: b.totalsHT.total, sansTCG: b.totalsHT.sansTCG };

    const data = [
      { key:'Jeux', name:'Jeux de société', value:b.totalsHT.Jeux },
      { key:'Accessoires', name:'Accessoires', value:b.totalsHT.Accessoires },
      { key:'TCG', name:'TCG', value:b.totalsHT.TCG },
    ];

    const card = buildSingleCard({
      title: 'Répartition (catégories) — clic pour ouvrir',
      listTitle: 'Catégories',
      data,
      totals,
      onPick: (d)=>{ view = { level:'category', category:d.key, tcgLicense:null, globalOnly: parsed.two }; render(); }
    });

    els.rightBody.appendChild(card);
  }

  function renderCategory(){
    const b = currentBucket();
    const cat = view.category;

    els.rightTitle.textContent = `${parsed.activeKey === 'GLOBAL' ? 'GLOBAL' : (BOUTIQUES.find(x=>x.key===parsed.activeKey)?.label || parsed.activeKey)} — ${cat}`;

    const totals = { total: b.totalsHT.total, sansTCG: b.totalsHT.sansTCG };

    if(cat === 'Jeux' || cat === 'Accessoires'){
      const map = b.sub[cat];
      const entries = [...map.entries()].map(([name, obj]) => ({ key:name, name, value: obj.value }));

      const card = buildSingleCard({
        title: `Répartition — ${cat} (toutes les sous-catégories)`,
        listTitle: cat,
        data: entries,
        totals,
        onPick: null
      });

      els.rightBody.appendChild(card);
      return;
    }

    // TCG => licenses
    const licEntries = [...b.sub.TCG.licenses.entries()].map(([lic,obj])=>({ key:lic, name: lic, value: obj.value }));

    const card = buildSingleCard({
      title: 'Répartition — TCG (licences)',
      listTitle: 'TCG — licences',
      data: licEntries,
      totals,
      onPick: (d)=>{ view = { level:'tcgLicense', category:'TCG', tcgLicense:d.key, globalOnly: parsed.two }; render(); }
    });

    els.rightBody.appendChild(card);
  }

  function renderTcgLicense(){
    const b = currentBucket();
    const lic = view.tcgLicense;

    els.rightTitle.textContent = `${parsed.activeKey === 'GLOBAL' ? 'GLOBAL' : (BOUTIQUES.find(x=>x.key===parsed.activeKey)?.label || parsed.activeKey)} — TCG — ${lic}`;

    const totals = { total: b.totalsHT.total, sansTCG: b.totalsHT.sansTCG };

    const seriesMap = b.sub.TCG.seriesByLicense.get(lic) || new Map();
    const series = [...seriesMap.entries()].map(([name,obj])=>({ key:name, name, value: obj.value }));

    const card = buildSingleCard({
      title: `Répartition — ${lic} (séries)`,
      listTitle: `${lic} — séries`,
      data: series,
      totals,
      onPick: null
    });

    els.rightBody.appendChild(card);
  }

  // ===== Back button =====
  els.btnBack.addEventListener('click', () => {
    if(view.level === 'tcgLicense') view = { level:'category', category:'TCG', tcgLicense:null, globalOnly: parsed?.two || false };
    else if(view.level === 'category') view = { level:'dashboard', category:null, tcgLicense:null, globalOnly: parsed?.two || false };
    else view = { level:'dashboard', category:null, tcgLicense:null, globalOnly: parsed?.two || false };
    render();
  });

  // ===== tutoriel =====
  const tutorialPages = [
    { title: "1) Choisir la boutique", text: "Dans PrestaShop, sélectionne la boutique Pigalle OU Gambetta depuis un onglet (ex : Tableau de bord)." },
    { title: "2) Accéder au rapport", text: "Va dans Commandes → Rapport Commandes TVA Bénéfices." },
    { title: "3) Paramétrer l’export", text: "Préférences d’export : Type de rapport = Catégories ; Format = html." },
    { title: "4) Définir la période", text: "Dans Par date de commande : date début et date fin (journée = même date)." },
    { title: "5) Statuts", text: "Tout décocher, puis cocher uniquement Store - Sale." },
    { title: "6) Copier", text: "Cliquer Exporter → Ctrl+A puis Ctrl+C sur le tableau." },
    { title: "7) Coller + Résultat", text: "Dans cette app : bouton Coller (ou Ctrl+V). Les résultats s’affichent automatiquement." }
  ];
  let tutPage = 0;
  function renderTut(){
    const p = tutorialPages[tutPage];
    els.tutContent.innerHTML = `
      <h3 class="pageTitle">${escapeHtml(p.title)}</h3>
      <div class="pageText">${escapeHtml(p.text)}</div>
      <div class="muted" style="margin-top:10px">Astuce : si 2 boutiques sont collées, l’app passe en mode GLOBAL.</div>
    `;
    els.tutIdx.textContent = String(tutPage+1);
    els.tutTotal.textContent = String(tutorialPages.length);
    els.tutPrev.disabled = tutPage === 0;
    els.tutNext.textContent = (tutPage === tutorialPages.length-1) ? 'Terminer' : 'Suivant';
  }
  function openTut(){ tutPage = 0; renderTut(); els.tutBg.style.display='flex'; els.tutBg.setAttribute('aria-hidden','false'); }
  function closeTut(){ els.tutBg.style.display='none'; els.tutBg.setAttribute('aria-hidden','true'); }
  els.btnTut.addEventListener('click', openTut);
  els.btnCloseTut.addEventListener('click', closeTut);
  els.tutBg.addEventListener('click', (e)=>{ if(e.target === els.tutBg) closeTut(); });
  els.tutPrev.addEventListener('click', ()=>{ if(tutPage>0){ tutPage--; renderTut(); }});
  els.tutNext.addEventListener('click', ()=>{ if(tutPage<tutorialPages.length-1){ tutPage++; renderTut(); } else closeTut(); });

  // ===== settings =====
  function openSet(){
    els.showQty.value = settings.showQty;
    els.setBg.style.display = 'flex';
    els.setBg.setAttribute('aria-hidden','false');
  }
  function closeSet(){
    els.setBg.style.display = 'none';
    els.setBg.setAttribute('aria-hidden','true');
  }
  els.btnSettings.addEventListener('click', openSet);
  els.btnCloseSet.addEventListener('click', closeSet);
  els.setBg.addEventListener('click', (e)=>{ if(e.target === els.setBg) closeSet(); });
  els.btnSaveSet.addEventListener('click', ()=>{
    settings.showQty = els.showQty.value;
    localStorage.setItem('lgdj_qty', settings.showQty);
    closeSet();
  });

  // ===== changelog =====
  const changelog = [
    {
      ver: "v0.6.1",
      items: [
        "Paramètres : suppression HT/TTC (HT only)",
        "Résultats : 1 seule carte (camembert + liste) par vue",
        "Zone de copie : plus slim",
        "Analyse auto dès que du texte est collé (plus de bouton Analyser)",
        "Tutoriel : modal taille fixe (plus de saut de mise en page)"
      ]
    },
    {
      ver: "v0.6.0",
      items: [
        "Bouton Coller + Vider",
        "Scroll résultats",
        "Camembert toutes sous-catégories",
        "Détails des lignes (Lues/Utilisées/Erreurs)"
      ]
    }
  ];

  function openVer(){
    els.verContent.innerHTML = changelog.map(block => {
      const li = block.items.map(x=>`<li>${escapeHtml(x)}</li>`).join('');
      return `
        <h3 class="pageTitle">${escapeHtml(block.ver)}</h3>
        <ul class="pageText" style="margin-top:8px">${li}</ul>
        <div class="divider" style="margin:14px 0"></div>
      `;
    }).join('');
    els.verBg.style.display='flex';
    els.verBg.setAttribute('aria-hidden','false');
  }
  function closeVer(){
    els.verBg.style.display='none';
    els.verBg.setAttribute('aria-hidden','true');
  }
  els.btnVer.addEventListener('click', openVer);
  els.btnCloseVer.addEventListener('click', closeVer);
  els.verBg.addEventListener('click', (e)=>{ if(e.target === els.verBg) closeVer(); });

  // ===== stats debug =====
  let statsTab = 'used';
  function setStatsTab(tab){
    statsTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    const arr = debug[tab] || [];
    const title = tab === 'used' ? 'Lignes utilisées (prises en compte)' : (tab === 'err' ? 'Erreurs (non prises en compte)' : 'Ignorées (hors tableau / hors boutique)');
    els.statsHint.textContent = `${title} — ${arr.length} ligne(s).`;
    els.statsBox.textContent = arr.map(x => x.line).join('\n');
  }
  function openStats(){
    els.statsBg.style.display='flex';
    els.statsBg.setAttribute('aria-hidden','false');
    setStatsTab(statsTab);
  }
  function closeStats(){
    els.statsBg.style.display='none';
    els.statsBg.setAttribute('aria-hidden','true');
  }
  els.btnStats.addEventListener('click', openStats);
  els.btnCloseStats.addEventListener('click', closeStats);
  els.statsBg.addEventListener('click', (e)=>{ if(e.target === els.statsBg) closeStats(); });
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', ()=> setStatsTab(t.dataset.tab)));
  els.btnCopyStats.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(els.statsBox.textContent || '');
    } catch(e){
      const ta = document.createElement('textarea');
      ta.value = els.statsBox.textContent || '';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }
  });

  // ===== input controls =====
  els.btnClear.addEventListener('click', ()=>{ els.raw.value=''; parseAll(); els.raw.focus(); });

  els.btnPaste.addEventListener('click', async ()=>{
    try{
      const txt = await navigator.clipboard.readText();
      if(txt){
        els.raw.value = txt;
        parseAll();
        return;
      }
    } catch(e) {
      // Clipboard API peut être bloquée en file:// → fallback
    }
    els.raw.focus();
  });

  // Auto analyse on input (debounced)
  let tmr = null;
  els.raw.addEventListener('input', ()=>{
    if(tmr) clearTimeout(tmr);
    tmr = setTimeout(parseAll, 220);
  });

  // initial render
  el('ver2').textContent = VERSION;
  els.btnVer.textContent = VERSION;
  render();
</script>
</body>
</html>
